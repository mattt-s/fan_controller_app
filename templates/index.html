<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fan Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; }
        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
            vertical-align: middle;
        }
        .status-on { background-color: limegreen; }
        .status-off { background-color: red; }
        .error-banner { margin-top: 15px; }
        /* Modified chart container to allow potentially different heights if needed */
        .chart-container {
            max-width: 600px; /* Increased max-width for better history chart display */
            margin: 20px auto;
            position: relative; /* Needed for tooltip positioning */
            height: 50px; /* Give the history chart a fixed height */
        }
         /* Specific style for the pie chart container */
        .pie-chart-container {
             max-width: 400px;
             margin: 20px auto;
        }

        .form-label { font-weight: 500;} /* Make labels slightly bolder */
        .config-details { font-size: 0.9em; color: #555; } /* Style for displaying config */
        .card-body .row { margin-bottom: 0.8rem; } /* Consistent spacing */
        .history-chart-wrapper {
            margin: 20px auto;
            max-width: 600px; /* Match chart-container max-width */
        }
        .chart-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.25rem; /* Similar size to card titles */
            font-weight: 500;
        }
    </style>
</head>
<body>
<div class="container">

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <h1 class="mb-4">Fan Control Status</h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Current Status</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Temperature:</strong> <span id="current-temp">{{ current_temp }}</span> °C</p>
                    <p class="config-details">Monitoring Path: {{ temp_path }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Fan State:</strong>
                        <span id="fan-state-text">{{ fan_state }}</span>
                        <span id="fan-state-indicator" class="status-indicator {{ 'status-on' if fan_state == 'ON' else 'status-off' }}"></span>
                    </p>
                    <p class="config-details">Using Serial Port: {{ serial_port }}</p>
                </div>
            </div>
            {% if last_error %}
            <div class="alert alert-danger error-banner" role="alert">
                <strong>Error:</strong> {{ last_error }}
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Update Settings</h5>
            <form action="{{ url_for('update_settings') }}" method="post">
                <h6>Temperature Thresholds</h6>
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="threshold_ceiling" class="col-form-label form-label">Turn Fan ON above (°C):</label>
                    </div>
                    <div class="col-md-3">
                        <input type="number" step="0.1" id="threshold_ceiling" name="threshold_ceiling" class="form-control" value="{{ threshold_ceiling }}">
                    </div>
                    <div class="col-md-3">
                        <label for="threshold_floor" class="col-form-label form-label">Turn Fan OFF below (°C):</label>
                    </div>
                    <div class="col-md-3">
                        <input type="number" step="0.1" id="threshold_floor" name="threshold_floor" class="form-control" value="{{ threshold_floor }}">
                    </div>
                </div>

                <h6 class="mt-3">Serial Commands (Hex)</h6>
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="command_open_hex" class="col-form-label form-label">Fan ON Command:</label>
                    </div>
                    <div class="col-md-9">
                        <input type="text" id="command_open_hex" name="command_open_hex" class="form-control" value="{{ command_open_hex }}" pattern="[0-9a-fA-F]+" title="Enter Hexadecimal characters only (0-9, a-f, A-F)">
                    </div>
                </div>
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="command_close_hex" class="col-form-label form-label">Fan OFF Command:</label>
                    </div>
                    <div class="col-md-9">
                        <input type="text" id="command_close_hex" name="command_close_hex" class="form-control" value="{{ command_close_hex }}" pattern="[0-9a-fA-F]+" title="Enter Hexadecimal characters only (0-9, a-f, A-F)">
                    </div>
                </div>

                <h6 class="mt-3">Temperature Source</h6>
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="temp_path" class="col-form-label form-label">Temperature File Path:</label>
                    </div>
                    <div class="col-md-9">
                        <input type="text" id="temp_path" name="temp_path" class="form-control" value="{{ temp_path }}">
                    </div>
                </div>
                <h6 class="mt-3">History Settings</h6>
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <label for="check_interval_seconds" class="col-form-label form-label">Check Interval (s):</label>
                    </div>
                    <div class="col-md-3">
                        <input type="number" id="check_interval_seconds" name="check_interval_seconds" class="form-control" value="{{ check_interval_seconds }}">
                    </div>
                    <div class="col-md-3">
                        <label for="history_duration_hours" class="col-form-label form-label">History Duration (h):</label>
                    </div>
                    <div class="col-md-3">
                        <input type="number" id="history_duration_hours" name="history_duration_hours" class="form-control" value="{{ history_duration_hours }}">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary mt-3">Update & Save Settings</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Fan Usage Summary (Last {{ history_duration_hours }} Hours)</h5>
            <p class="text-center small config-details">Based on check interval: {{ check_interval_seconds }}s</p>
            <div class="pie-chart-container"> {# Specific container for the pie chart #}
                <canvas id="fanUsageChart"></canvas>
            </div>
            <p class="text-center small" id="chart-stats"></p>


            {# --- START: New section for History Timeline Chart --- #}
            <h5 class="card-title mt-4">Fan State Timeline (Last {{ history_duration_hours }} Hours)</h5>
            <div class="history-chart-wrapper"> {# Wrapper for history chart #}
                <div class="chart-container" style="height: 50px;"> {# Fixed height for the bar #}
                    <canvas id="fanHistoryChart"></canvas>
                </div>
            </div>
            {# --- END: New section for History Timeline Chart --- #}

        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    let fanChart; // Variable to hold the pie chart instance
    let historyChart; // Variable to hold the history bar chart instance

    function updatePieChart(data) {
        const ctx = document.getElementById('fanUsageChart').getContext('2d');
        const chartData = {
            labels: ['On Time (%)', 'Off Time (%)'],
            datasets: [{
                label: 'Fan Usage Ratio',
                data: [data.on_percentage, data.off_percentage],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)', // Greenish for ON
                    'rgba(255, 99, 132, 0.8)'  // Reddish for OFF
                ],
                 // Add border colors for better separation
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
            }]
        };

        if (fanChart) {
            // Update existing chart
            fanChart.data.datasets[0].data = [data.on_percentage, data.off_percentage];
            fanChart.update();
        } else {
            // Create new chart
            fanChart = new Chart(ctx, {
                type: 'pie', // Pie chart for ratio
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow more control over size
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
         // Update stats text
         const onHours = Math.floor(data.total_on_seconds / 3600);
         const onMinutes = Math.floor((data.total_on_seconds % 3600) / 60);
         const onSeconds = Math.floor(data.total_on_seconds % 60); // Include seconds
         const offHours = Math.floor(data.total_off_seconds / 3600);
         const offMinutes = Math.floor((data.total_off_seconds % 3600) / 60);
          const offSeconds = Math.floor(data.total_off_seconds % 60); // Include seconds

         // More detailed time display
         let onTimeStr = '';
         if (onHours > 0) onTimeStr += `${onHours}h `;
         if (onMinutes > 0 || onHours > 0) onTimeStr += `${onMinutes}m `;
         onTimeStr += `${onSeconds}s`;

         let offTimeStr = '';
         if (offHours > 0) offTimeStr += `${offHours}h `;
         if (offMinutes > 0 || offHours > 0) offTimeStr += `${offMinutes}m `;
         offTimeStr += `${offSeconds}s`;

         document.getElementById('chart-stats').innerText =
            `Total On: ${onTimeStr} | Total Off: ${offTimeStr}`;
    }

    function updateHistoryChart(segments) {
        const ctx = document.getElementById('fanHistoryChart').getContext('2d');

        // Prepare data for the stacked horizontal bar chart
        // Each data point in the dataset is the duration of a segment
        const durations = segments.map(s => s.duration_seconds);
        const backgroundColors = segments.map(s => s.state === 'ON' ? 'rgba(75, 192, 192, 0.8)' : 'rgba(255, 99, 132, 0.8)');
         const borderColors = segments.map(s => s.state === 'ON' ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)');


        const historyChartData = {
            labels: ['Timeline'], // Single label for the Y axis
            datasets: [{
                label: 'Fan State Timeline',
                 // No individual label per segment needed in the legend
                data: durations,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1,
                stack: 'historyStack', // Group all segments into one bar visually
                 hoverBackgroundColor: backgroundColors.map(color => color.replace('0.8', '1.0')), // Brighter on hover
                 hoverBorderColor: borderColors.map(color => color.replace('1)', '1)')) // Keep border solid on hover
            }]
        };

        const historyChartOptions = {
            indexAxis: 'y', // Make it a horizontal bar chart
            scales: {
                x: {
                    stacked: true, // Stack segments horizontally
                    title: {
                        display: true,
                        text: 'Time' // Or "Time (seconds/minutes/hours)"
                    },
                    beginAtZero: true, // Start x-axis from zero
                    ticks: {
                         callback: function(value, index, ticks) {
                             // Format x-axis ticks (optional, can be left as seconds)
                             // Example: convert seconds to H:M:S or just show seconds
                             if (value >= 3600) return (value / 3600).toFixed(1) + 'h';
                             if (value >= 60) return (value / 60).toFixed(0) + 'm';
                             return value + 's';
                         }
                    }
                },
                y: {
                    stacked: true, // Stack is applied per y-category (only one here)
                    beginAtZero: true,
                    display: false // Hide the 'Timeline' label on the y-axis
                }
            },
            plugins: {
                legend: {
                    display: false // Hide the dataset legend (we use colors directly)
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            // Find the corresponding segment data
                            const segmentIndex = context.dataIndex;
                            const segment = segments[segmentIndex]; // Get the original segment data

                            const duration = segment.duration_seconds;
                            const state = segment.state;

                            // Format duration nicely
                            const hours = Math.floor(duration / 3600);
                            const minutes = Math.floor((duration % 3600) / 60);
                            const seconds = Math.floor(duration % 60);

                            let durationString = '';
                            if (hours > 0) durationString += `${hours}h `;
                            if (minutes > 0 || hours > 0) durationString += `${minutes}m `; // Show minutes if > 0 or hours > 0
                            durationString += `${seconds}s`;

                            return `${state}: ${durationString}`;
                        },
                         title: function(context) {
                             // Optional: Add start/end time to tooltip title
                             // This requires sending start/end times from Python
                             // For simplicity, leaving title empty or basic
                             return ''; // No title
                         }
                    }
                }
            },
             hover: {
                  mode: 'nearest',
                  intersect: true
             },
            responsive: true,
            maintainAspectRatio: false // Important for controlling height with CSS
        };


        if (historyChart) {
            // Update existing chart data and options
            historyChart.data.datasets[0].data = durations;
            historyChart.data.datasets[0].backgroundColor = backgroundColors;
            historyChart.data.datasets[0].borderColor = borderColors;
             historyChart.options.plugins.tooltip.callbacks.label = historyChartOptions.plugins.tooltip.callbacks.label; // Ensure tooltip callback is updated
            historyChart.update();
        } else {
            // Create new chart
            historyChart = new Chart(ctx, {
                type: 'bar', // Use 'bar' type
                data: historyChartData,
                options: historyChartOptions
            });
        }
    }


    // Fetch chart data on page load
    fetch('/chart_data')
        .then(response => response.json())
        .then(data => {
            updatePieChart(data); // Update pie chart
            updateHistoryChart(data.history_segments); // Update history bar chart
        })
        .catch(error => console.error('Error fetching chart data:', error));

    // Optional: Auto-refresh status and chart (every 10 seconds)
    // You can uncomment this block if you want the page to update automatically
    /*
    setInterval(() => {
         // Fetch status data
         fetch('/status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('current-temp').innerText = data.current_temp !== null ? data.current_temp.toFixed(1) : "N/A";
                const fanStateText = data.fan_state ? "ON" : "OFF";
                const fanStateClass = data.fan_state ? "status-on" : "status-off";
                document.getElementById('fan-state-text').innerText = fanStateText;
                const indicator = document.getElementById('fan-state-indicator');
                indicator.className = `status-indicator ${fanStateClass}`;
                // Update error display if needed - requires more logic
            })
            .catch(error => console.error('Error fetching status:', error));

         // Fetch and update chart data periodically too
         fetch('/chart_data')
            .then(response => response.json())
            .then(data => {
                updatePieChart(data);
                updateHistoryChart(data.history_segments);
            })
            .catch(error => console.error('Error fetching chart data:', error));
    }, 10000); // Refresh every 10000 ms (10 seconds)
    */

</script>
</body>
</html>